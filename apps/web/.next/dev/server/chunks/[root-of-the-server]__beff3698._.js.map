{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["C:/Users/Adoonl/Desktop/triviaNFT/services/api/src/db/connection.ts"],"sourcesContent":["/**\r\n * Database Connection Utility\r\n * \r\n * Provides connection pooling and query helpers for PostgreSQL database.\r\n * Optimized for Neon PostgreSQL with serverless connection pooling.\r\n * Supports both pooled connections (for Vercel Functions) and direct connections (for migrations).\r\n */\r\n\r\nimport { Pool, QueryResult, PoolClient, QueryResultRow } from 'pg';\r\n\r\ninterface DatabaseConfig {\r\n  connectionString: string;\r\n  ssl: boolean;\r\n  max: number;\r\n  idleTimeoutMillis: number;\r\n  connectionTimeoutMillis: number;\r\n}\r\n\r\nlet poolInstance: Pool | null = null;\r\n\r\n/**\r\n * Get database configuration optimized for Neon PostgreSQL\r\n * \r\n * Neon-specific optimizations:\r\n * - Uses connection pooling via Neon's pooler endpoint (-pooler suffix)\r\n * - SSL is always enabled for Neon connections\r\n * - Smaller pool size (10) optimized for serverless functions\r\n * - Shorter idle timeout (20s) to release connections quickly\r\n */\r\nfunction getDatabaseConfig(): DatabaseConfig {\r\n  // DATABASE_URL should point to Neon's pooled connection string\r\n  // Format: postgresql://user:pass@host-pooler.neon.tech/db?sslmode=require\r\n  const connectionString = process.env.DATABASE_URL;\r\n  \r\n  if (!connectionString) {\r\n    throw new Error('DATABASE_URL environment variable must be set');\r\n  }\r\n\r\n  // Validate that we're using a Neon connection string\r\n  if (!connectionString.includes('neon.tech') && process.env.NODE_ENV === 'production') {\r\n    console.warn('Warning: DATABASE_URL does not appear to be a Neon connection string');\r\n  }\r\n\r\n  // Check if using pooled connection (recommended for serverless)\r\n  const isPooled = connectionString.includes('-pooler.');\r\n  if (!isPooled && process.env.NODE_ENV === 'production') {\r\n    console.warn('Warning: Using direct Neon connection instead of pooled connection. Consider using the pooled endpoint for better performance.');\r\n  }\r\n\r\n  return {\r\n    connectionString,\r\n    ssl: true, // Always use SSL for Neon\r\n    max: 10, // Smaller pool size for serverless (Neon handles pooling)\r\n    idleTimeoutMillis: 20000, // 20 seconds - release idle connections quickly\r\n    connectionTimeoutMillis: 10000, // 10 seconds - fail fast if can't connect\r\n  };\r\n}\r\n\r\n/**\r\n * Get or create database connection pool\r\n * \r\n * For Neon PostgreSQL:\r\n * - Uses pooled connection string (via Neon's connection pooler)\r\n * - SSL is always enabled\r\n * - Optimized pool settings for serverless environments\r\n * - Connection pooling is handled by Neon's infrastructure\r\n */\r\nexport async function getPool(): Promise<Pool> {\r\n  if (poolInstance) {\r\n    return poolInstance;\r\n  }\r\n\r\n  const config = getDatabaseConfig();\r\n  \r\n  poolInstance = new Pool({\r\n    connectionString: config.connectionString,\r\n    ssl: config.ssl ? { rejectUnauthorized: false } : undefined,\r\n    max: config.max,\r\n    idleTimeoutMillis: config.idleTimeoutMillis,\r\n    connectionTimeoutMillis: config.connectionTimeoutMillis,\r\n    statement_timeout: 30000, // 30 second query timeout\r\n  });\r\n\r\n  // Handle pool errors\r\n  poolInstance.on('error', (err: Error) => {\r\n    console.error('Unexpected database pool error:', err);\r\n  });\r\n\r\n  // Log connection info (without credentials)\r\n  const urlObj = new URL(config.connectionString);\r\n  console.log('Database pool initialized:', {\r\n    host: urlObj.hostname,\r\n    database: urlObj.pathname.slice(1),\r\n    ssl: config.ssl,\r\n    maxConnections: config.max,\r\n    isNeonPooled: urlObj.hostname.includes('-pooler.'),\r\n  });\r\n\r\n  return poolInstance;\r\n}\r\n\r\n/**\r\n * Execute a query with automatic connection management\r\n */\r\nexport async function query<T extends QueryResultRow = any>(\r\n  text: string,\r\n  params?: any[]\r\n): Promise<QueryResult<T>> {\r\n  const pool = await getPool();\r\n  \r\n  try {\r\n    const start = Date.now();\r\n    const result = await pool.query<T>(text, params);\r\n    const duration = Date.now() - start;\r\n    \r\n    // Log slow queries (> 1 second)\r\n    if (duration > 1000) {\r\n      console.warn('Slow query detected:', {\r\n        duration,\r\n        text: text.substring(0, 100),\r\n        rowCount: result.rowCount,\r\n      });\r\n    }\r\n    \r\n    return result;\r\n  } catch (error) {\r\n    console.error('Database query error:', {\r\n      error,\r\n      text: text.substring(0, 100),\r\n    });\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Execute a transaction with automatic rollback on error\r\n */\r\nexport async function transaction<T>(\r\n  callback: (client: PoolClient) => Promise<T>\r\n): Promise<T> {\r\n  const pool = await getPool();\r\n  const client = await pool.connect();\r\n  \r\n  try {\r\n    await client.query('BEGIN');\r\n    const result = await callback(client);\r\n    await client.query('COMMIT');\r\n    return result;\r\n  } catch (error) {\r\n    await client.query('ROLLBACK');\r\n    console.error('Transaction error:', error);\r\n    throw error;\r\n  } finally {\r\n    client.release();\r\n  }\r\n}\r\n\r\n/**\r\n * Close the database connection pool\r\n * Should be called when Lambda container is shutting down\r\n */\r\nexport async function closePool(): Promise<void> {\r\n  if (poolInstance) {\r\n    await poolInstance.end();\r\n    poolInstance = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Health check - verify database connection\r\n */\r\nexport async function healthCheck(): Promise<boolean> {\r\n  try {\r\n    const result = await query('SELECT 1 as health');\r\n    return result.rows[0]?.health === 1;\r\n  } catch (error) {\r\n    console.error('Database health check failed:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Get database statistics\r\n */\r\nexport async function getStats(): Promise<{\r\n  totalConnections: number;\r\n  idleConnections: number;\r\n  waitingClients: number;\r\n}> {\r\n  const pool = await getPool();\r\n  \r\n  return {\r\n    totalConnections: pool.totalCount,\r\n    idleConnections: pool.idleCount,\r\n    waitingClients: pool.waitingCount,\r\n  };\r\n}\r\n"],"names":["Pool","poolInstance","getDatabaseConfig","connectionString","process","env","DATABASE_URL","Error","includes","NODE_ENV","console","warn","isPooled","ssl","max","idleTimeoutMillis","connectionTimeoutMillis","getPool","_getPool","apply","arguments","_asyncToGenerator","config","rejectUnauthorized","undefined","statement_timeout","on","err","error","urlObj","URL","log","host","hostname","database","pathname","slice","maxConnections","isNeonPooled","query","_x","_x2","_query","text","params","pool","start","Date","now","result","duration","substring","rowCount","transaction","_x3","_transaction","callback","client","connect","release","closePool","_closePool","end","healthCheck","_healthCheck","_result$rows$","rows","health","getStats","_getStats","totalConnections","totalCount","idleConnections","idleCount","waitingClients","waitingCount"],"mappings":"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","ignoreList":[]}},
    {"offset": {"line": 187, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Adoonl/Desktop/triviaNFT/node_modules/%40babel/runtime/helpers/asyncToGenerator.js"],"sourcesContent":["function asyncGeneratorStep(n, t, e, r, o, a, c) {\n  try {\n    var i = n[a](c),\n      u = i.value;\n  } catch (n) {\n    return void e(n);\n  }\n  i.done ? t(u) : Promise.resolve(u).then(r, o);\n}\nfunction _asyncToGenerator(n) {\n  return function () {\n    var t = this,\n      e = arguments;\n    return new Promise(function (r, o) {\n      var a = n.apply(t, e);\n      function _next(n) {\n        asyncGeneratorStep(a, r, o, _next, _throw, \"next\", n);\n      }\n      function _throw(n) {\n        asyncGeneratorStep(a, r, o, _next, _throw, \"throw\", n);\n      }\n      _next(void 0);\n    });\n  };\n}\nmodule.exports = _asyncToGenerator, module.exports.__esModule = true, module.exports[\"default\"] = module.exports;"],"names":[],"mappings":"AAAA,SAAS,mBAAmB,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC;IAC7C,IAAI;QACF,IAAI,IAAI,CAAC,CAAC,EAAE,CAAC,IACX,IAAI,EAAE,KAAK;IACf,EAAE,OAAO,GAAG;QACV,OAAO,KAAK,EAAE;IAChB;IACA,EAAE,IAAI,GAAG,EAAE,KAAK,QAAQ,OAAO,CAAC,GAAG,IAAI,CAAC,GAAG;AAC7C;AACA,SAAS,kBAAkB,CAAC;IAC1B,OAAO;QACL,IAAI,IAAI,IAAI,EACV,IAAI;QACN,OAAO,IAAI,QAAQ,SAAU,CAAC,EAAE,CAAC;YAC/B,IAAI,IAAI,EAAE,KAAK,CAAC,GAAG;YACnB,SAAS,MAAM,CAAC;gBACd,mBAAmB,GAAG,GAAG,GAAG,OAAO,QAAQ,QAAQ;YACrD;YACA,SAAS,OAAO,CAAC;gBACf,mBAAmB,GAAG,GAAG,GAAG,OAAO,QAAQ,SAAS;YACtD;YACA,MAAM,KAAK;QACb;IACF;AACF;AACA,OAAO,OAAO,GAAG,mBAAmB,OAAO,OAAO,CAAC,UAAU,GAAG,MAAM,OAAO,OAAO,CAAC,UAAU,GAAG,OAAO,OAAO","ignoreList":[0]}}]
}