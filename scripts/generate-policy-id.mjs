#!/usr/bin/env node
/**
 * Generate Cardano NFT Policy ID
 * 
 * This script creates a native script policy for NFT minting and outputs the policy ID.
 * The policy uses your wallet's payment key hash to ensure only you can mint NFTs.
 * 
 * Usage:
 *   node scripts/generate-policy-id.mjs
 * 
 * Requirements:
 *   - WALLET_SEED_PHRASE in environment
 *   - CARDANO_NETWORK in environment (preprod or mainnet)
 *   - BLOCKFROST_PROJECT_ID in environment
 */

import { Blockfrost, Lucid } from 'lucid-cardano';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Load environment variables from .env.local
function loadEnv() {
  const envPath = path.join(process.cwd(), 'services', 'api', '.env.local');
  if (fs.existsSync(envPath)) {
    const envContent = fs.readFileSync(envPath, 'utf-8');
    envContent.split('\n').forEach(line => {
      const match = line.match(/^([^#=]+)=(.*)$/);
      if (match) {
        const key = match[1].trim();
        const value = match[2].trim();
        if (!process.env[key]) {
          process.env[key] = value;
        }
      }
    });
  }
}

loadEnv();

// Load environment variables
const WALLET_SEED_PHRASE = process.env.WALLET_SEED_PHRASE;
const CARDANO_NETWORK = process.env.CARDANO_NETWORK || 'preprod';
const BLOCKFROST_PROJECT_ID = process.env.BLOCKFROST_PROJECT_ID;

async function generatePolicyId() {
  console.log('ğŸ” Generating NFT Policy ID...\n');

  // Validate environment
  if (!WALLET_SEED_PHRASE) {
    console.error('âŒ Error: WALLET_SEED_PHRASE not found in environment');
    console.error('   Please set it in services/api/.env.local');
    process.exit(1);
  }

  if (!BLOCKFROST_PROJECT_ID) {
    console.error('âŒ Error: BLOCKFROST_PROJECT_ID not found in environment');
    console.error('   Please set it in services/api/.env.local');
    process.exit(1);
  }

  try {
    // Initialize Lucid with Blockfrost
    console.log(`ğŸ“¡ Connecting to Cardano ${CARDANO_NETWORK}...`);
    const lucid = await Lucid.new(
      new Blockfrost(
        `https://cardano-${CARDANO_NETWORK}.blockfrost.io/api/v0`,
        BLOCKFROST_PROJECT_ID
      ),
      CARDANO_NETWORK === 'mainnet' ? 'Mainnet' : 'Preprod'
    );

    // Load wallet from seed phrase
    console.log('ğŸ”‘ Loading wallet from seed phrase...');
    lucid.selectWalletFromSeed(WALLET_SEED_PHRASE);

    // Get payment credential (key hash)
    const address = await lucid.wallet.address();
    console.log(`   Wallet address: ${address}`);
    
    const paymentCredential = lucid.utils.getAddressDetails(address).paymentCredential;

    if (!paymentCredential) {
      throw new Error('Could not extract payment credential from wallet');
    }

    // Create native script policy
    // This policy allows only the wallet owner to mint/burn NFTs
    const nativeScript = lucid.utils.nativeScriptFromJson({
      type: 'sig',
      keyHash: paymentCredential.hash,
    });

    console.log('ğŸ“œ Creating native script policy...');
    console.log(`   Key Hash: ${paymentCredential.hash}\n`);

    // Calculate policy ID from the native script
    const policyId = lucid.utils.mintingPolicyToId(nativeScript);

    // Display results
    console.log('âœ… Policy ID Generated Successfully!\n');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log(`Policy ID: ${policyId}`);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

    // Save to .env files
    console.log('ğŸ’¾ Updating environment files...\n');

    const envFiles = [
      'services/api/.env.local',
      'services/api/.env',
    ];

    for (const envFile of envFiles) {
      const envPath = path.join(process.cwd(), envFile);
      
      if (fs.existsSync(envPath)) {
        let content = fs.readFileSync(envPath, 'utf-8');
        
        // Check if NFT_POLICY_ID already exists
        if (content.includes('NFT_POLICY_ID=')) {
          // Replace existing value
          content = content.replace(
            /NFT_POLICY_ID=.*/,
            `NFT_POLICY_ID=${policyId}`
          );
          console.log(`   âœ“ Updated ${envFile}`);
        } else {
          // Add new line
          if (!content.endsWith('\n')) {
            content += '\n';
          }
          content += `\n# NFT Policy ID (generated by scripts/generate-policy-id.mjs)\nNFT_POLICY_ID=${policyId}\n`;
          console.log(`   âœ“ Added to ${envFile}`);
        }
        
        fs.writeFileSync(envPath, content, 'utf-8');
      } else {
        console.log(`   âš  Skipped ${envFile} (file not found)`);
      }
    }

    console.log('\nğŸ“‹ Next Steps:\n');
    console.log('1. Add this to your Vercel environment variables:');
    console.log(`   NFT_POLICY_ID=${policyId}\n`);
    console.log('2. This policy allows only your wallet to mint NFTs');
    console.log('3. Keep your WALLET_SEED_PHRASE secure - it controls minting!\n');

    // Save policy script for reference
    const policyScriptPath = path.join(process.cwd(), 'scripts', 'policy-script.json');
    fs.writeFileSync(
      policyScriptPath,
      JSON.stringify(nativeScript, null, 2),
      'utf-8'
    );
    console.log(`ğŸ’¾ Policy script saved to: scripts/policy-script.json\n`);

  } catch (error) {
    console.error('âŒ Error generating policy ID:', error);
    process.exit(1);
  }
}

// Run the script
generatePolicyId();
